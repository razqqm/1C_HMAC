# DownloadHmac File Server

DownloadHmac File Server – это пример ASP.NET-приложения, реализованного в виде HTTP-обработчика (ASHX), предназначенного для безопасной выдачи файлов по запросу с проверкой HMAC-подписи и проверкой источника запроса (IP-адреса и/или домена). Все важные параметры (путь к файлам, секрет для HMAC, разрешённые IP и домен) вынесены в конфигурационный файл **web.config** для удобной настройки.

## Особенности

- **Безопасная выдача файлов.** Обработчик выдает файл только после успешной проверки HMAC-подписи.
- **Гибкая настройка.** Все параметры, такие как путь к файлам, секрет HMAC, разрешенные IP-адреса и домен, задаются через ключи в `appSettings` файла web.config.
- **Проверка источника запроса.** Возможна проверка как IP-адреса (поддержка нескольких IP через разделитель запятая), так и домена (через UrlReferrer).
- **Совместимость с Integrated режимом IIS.** Пример настроен для работы в Application Pool, использующем Integrated Pipeline.
- **UTF-8 кодировка.** Настроена кодировка UTF-8 для обработки запросов и ответов, что позволяет избежать проблем с отображением символов.

## Структура проекта

```
C:\_files_iis\
│
├── web.config           # Файл конфигурации, содержащий все настройки (путь к файлам, HMAC-секрет, разрешённые IP/домен и т.д.)
│
├── DownloadHmac.ashx    # ASP.NET обработчик, реализующий логику выдачи файлов с проверкой HMAC
│
└── files\              # Папка, содержащая файлы, которые будут выдаваться (напр., test.txt)
```

## Установка и развертывание

1. **Настройка IIS:**
   - Создайте новый сайт в IIS с физическим путем, например, `C:\_files_iis\`.
   - Настройте привязки (bindings) для вашего сайта (HTTP/HTTPS, нужный порт, доменное имя).
   - Убедитесь, что сайт работает в Application Pool с .NET CLR v4.0 (Integrated mode).

2. **Размещение файлов:**
   - Скопируйте файл `web.config` и `DownloadHmac.ashx` в корневую папку сайта (например, `C:\_files_iis\`).
   - Создайте папку `files` в корне сайта и разместите в ней файлы для выдачи (например, `test.txt`).

3. **Настройка конфигурации:**
   Откройте файл `web.config` и отредактируйте ключи в секции `<appSettings>`:
   - **FilesFolder:** Укажите полный путь к папке с файлами (например, `C:\_files_iis\files`).
   - **HmacSecret:** Укажите секретный ключ для вычисления HMAC (например, `SUPER_SECRET_123`).
   - **AllowedIP:** (Опционально) Укажите один или несколько разрешённых IP-адресов через запятую (например, `192.168.1.100,192.168.1.101`).
   - **AllowedDomain:** (Опционально) Укажите разрешённый домен (например, `allowed.domain.com`).

   Пример настроек:
   ```xml
   <appSettings>
     <add key="FilesFolder" value="C:\_files_iis\files" />
     <add key="HmacSecret" value="SUPER_SECRET_123" />
     <add key="AllowedIP" value="192.168.1.100,192.168.1.101" />
     <add key="AllowedDomain" value="allowed.domain.com" />
   </appSettings>
   ```

## Как работает обработчик

1. **Проверка метода запроса:**  
   Обработчик принимает только GET-запросы.

2. **Проверка источника запроса:**  
   Если в конфигурации заданы `AllowedIP` и/или `AllowedDomain`, обработчик сравнивает IP-адрес клиента (`UserHostAddress`) и домен из `UrlReferrer` с разрешёнными значениями. Если ни один из признаков не совпадает, запрос отклоняется (HTTP 403).

3. **Проверка HMAC-подписи:**  
   Обработчик ожидает наличие заголовка `X-HMAC-Signature`. Он формирует каноническую строку в виде:
   ```
   GET
   {имя файла}
   ```
   и вычисляет HMAC‑SHA256 с использованием секрета из конфигурации. Если вычисленная подпись не совпадает с переданной, запрос отклоняется (HTTP 403).

4. **Выдача файла:**  
   Если все проверки пройдены, обработчик отдаёт запрошенный файл с заголовком Content-Disposition для скачивания.

## Пример использования с Postman

### Pre-request Script (вычисление HMAC):

```javascript
// Получаем секрет и имя файла из переменных или задаем напрямую
var secret = "SUPER_SECRET_123"; // или pm.environment.get("HmacSecret")
var fileName = pm.environment.get("fileName") || "test.txt";

// Формируем каноническую строку: "GET\n{имя файла}\n"
var canonicalString = "GET\n" + fileName + "\n";

// Вычисляем HMAC-SHA256
var signature = CryptoJS.HmacSHA256(canonicalString, secret).toString(CryptoJS.enc.Hex);

// Сохраняем значение в переменной окружения HMACSignature
pm.environment.set("HMACSignature", signature);

console.log("Canonical String: " + canonicalString);
console.log("Computed Signature: " + signature);
```

### Настройка запроса:
- **Метод:** GET
- **URL:**  
  ```
  https://files.localhost:888/DownloadHmac.ashx?file={{fileName}}
  ```
- **Headers:**
  - `X-HMAC-Signature: {{HMACSignature}}`
  - (Опционально) `Referer: https://allowed.domain.com/` – если используется проверка домена.
- **Переменные окружения:**  
  - `fileName` – имя запрашиваемого файла (например, `test.txt`).

## Дополнительные параметры для конфигурации

В дополнение к основным параметрам, вы можете вынести в конфигурацию:
- **Параметры логирования:** для включения детальных логов обработки запросов.
- **Параметры Content-Type:** если требуется выдавать файлы с другим типом содержимого.
- **Параметры кеширования:** если необходимо настроить кеширование выданных файлов.

## Заключение

Этот проект демонстрирует, как с помощью ASP.NET HTTP-обработчика можно реализовать безопасную выдачу файлов с использованием HMAC-подписи и проверки источника запроса (IP и домен). Все ключевые параметры вынесены в файл конфигурации, что позволяет легко адаптировать приложение под различные сценарии.

Если у вас есть вопросы или предложения, пожалуйста, откройте Issue или отправьте Pull Request.
